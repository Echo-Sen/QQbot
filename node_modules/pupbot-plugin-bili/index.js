const { PupPlugin, segment, http } = require('@pupbot/core')
const { version, name } = require('./package.json')
const plugin = new PupPlugin(name.replace("pupbot-plugin-", ''), version)
const axios = require('axios')
// UP主视频查看接口
// http://api.tangdouz.com/api/jsonshouye.php?dz=26

url = 'https://api.gmit.vip/Api/BiliBliHot?format=json'
//插件被启用调用函数
plugin.onMounted(() => {
    // B站热搜
    plugin.onMatch(/^#[Bb]$/, msg => {
        axios.get(url)
            .then(res => {
                // console.log(res.data)
                let str = '== B站实时热搜 =='
                res.data.data.forEach((element, index) => {
                    if (index >= 5) return false
                    str += '\n---------\n' + element.title + `\n播放量：${element.hot}\n` + element.url

                })
                msg.reply(str)
            })
    })
    // B站视频链接解析
    let url_b = 'https://tenapi.cn/v2/bilivideo?url='
    plugin.onMatch(/bilibili.com\/video\/BV\w{10}\/?/, msg => {
        // console.log(msg)
        axios.get(url_b + msg.raw_message.replace(/.+bilibili.com\/video\/BV/, 'bilibili.com/video/BV'))
            .then(res => {
                if (res.data.code == 200) {
                    let { data } = res.data
                    let str = [`${data.title}\nUP主：${data.name}`,
                    segment.image(data.cover),
                    ]
                    msg.reply(str, true)
                }
            })
    })
    // 
})

module.exports = { plugin }
